---
layout: doc
title: Provision a Microsoft AKS (Azure Kubernetes Service) Kubernetes Cluster
description: Provision an AKS cluster in Microsoft Azure
keywords: docker kubernetes k8s container aws
---

== Overview

This guide will show you how to quickly setup an AKS cluster on Microsoft Azure. When completed, you will have a fully functional Kubernetes cluster ready to deploy FusionAuth as well as a supporting Azure Database for PostgresSQL.
The following method uses the default settings when provisioning an AKS cluster with the required resources and services. It is recommended that you consult the https://docs.microsoft.com/en-us/azure/aks/[Azure Kubernetes Service docs] for details on how to customize the configuration for your use case.

== Requirements

* A https://portal.azure.com/[Microsoft Azure account] and active subscription with sufficient permissions to create resources.
* `az` - Azure command Line tool used to manage resources on Azure. For installation instructions, see https://docs.microsoft.com/en-us/cli/azure/install-azure-cli[How to install the Azure CLI].
+
include::/docs/v1/tech/installation-guide/kubernetes/_kubectl.adoc[]

== Architecture

The resulting architecture for this guide centers around creating an AKS cluster. By default, AKS creates a virtual network hosted by Azure cloud of which worker nodes connect to. You will create a PostgreSQL database and Elasticsearch cluster that will reside within the same virtual network.

The following reference architecture shows an example application deployed in AKS.

image::installation-guides/kubernetes/aks.png[EKS Architecture,width=1200,role=shadowed]

== Create an AKS cluster

=== Create a resource group

Before you create the cluster, you need to first create a https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/overview[Resource Group], a logical grouping of Azure resources. A resource group location is where resources will run by default when a region is not provided on creation.

Create a resource group.

[source,shell,title=Create a new resource group]
----
$ az group create --name fusionauthResourceGroup --location westus
----

[source,json,title=JSON output]
----
{
  "id": "/subscriptions/2683a458-c361-4b5e-87d9-a4e5237d5b91/resourceGroups/fusionauthResourceGroup",
  "location": "westus",
  "managedBy": null,
  "name": "fusionauthResourceGroup",
  "properties": {
    "provisioningState": "Succeeded"
  },
  "tags": null,
  "type": "Microsoft.Resources/resourceGroups"
}
----

=== Create the cluster

[source,shell,title=Create a new AKS cluster]
----
$ az aks create \
  --resource-group fusionauthResourceGroup \
  --name fusionauthCluster \
  --node-count 1 \
  --enable-addons monitoring \
  --generate-ssh-keys
----

More on these arguments:

* `resource-group` - The name of the resource group where the cluster will be created.
* `name` - The name of the cluster.
* `node-count` - The number of nodes in the replica set.
* `enable-addons` - The Kubernetes addons to enable.
* `generate-ssh-keys` - Generates SSH public and private key files in the ~/.ssh directory.
+
For more information on the https://docs.microsoft.com/en-us/cli/azure/aks?view=azure-cli-latest#az_aks_create[create] command, see https://docs.microsoft.com/en-us/cli/azure/aks?view=azure-cli-latest#az_aks_create[az aks create] documentation.

=== Update Kubernetes Configuration

The following retrieves credentials for the newly created cluster and then configures your `~/.kube/config` file so that you can use `kubectl` to connect to this cluster.

[source,shell,title=Get access credentials and update Kubeconfig]
----
$ az aks get-credentials \
  --resource-group fusionauthResourceGroup \
  --name fusionauthCluster
----

=== Verify Cluster Information

Execute the https://docs.microsoft.com/en-us/cli/azure/aks?view=azure-cli-latest#az_aks_list[list] command to see AKS clusters that have been configured.

[source,shell,title=Get list of AKS clusters]
----
$ az aks list
----

You now have a fully functional provisioned AKS cluster. For good measure, view the nodes that have been created.
Use `kubectl` to make requests to the Kubernetes API Server.

[source,shell,title=Get list of nodes running on the cluster]
----
$ kubectl get nodes -o wide

NAME                                STATUS   ROLES   AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME
aks-nodepool1-13281124-vmss000000   Ready    agent   8m42s   v1.20.9   10.240.0.4    <none>        Ubuntu 18.04.6 LTS   5.4.0-1059-azure   containerd://1.4.9+azure
----

Great! You have a node in a `READY` status. This means that the node is healthy and ready to accept pods.

== Create a Database

For this setup, you will create a PostgreSQL database. Such a database is required for FusionAuth.

[WARNING.warning]
====
Azure database names are globally unique and you may encounter the error, "Specified server name is already used". Consider appending your own unique identifier such as an organization name in this example.
====

[source,shell,title=Create a PostgreSQL flexible server]
----
$ az postgres flexible-server create \
  --resource-group fusionauthResourceGroup \
  --name fusionauth-db-<my-organization> \
  --location westus \
  --admin-user postgres \
  --admin-password changeMeToSomethingSecure \
  --version 12 \
  --public-access 0.0.0.0
----

More on these arguments:

* `resource-group` - The name of the resource group where the cluster will be created.
* `name` - The name of the database.
* `location` - The location.
* `admin-user` - The database admin user.
* `admin-password` - The database admin user password.
* `version` - The version of PostgreSQL to install.
* `public-access` - Allows public access in the firewall rules. The `0.0.0.0` parameter allows access to this database from any resource deployed in Azure.

+
For more information on the https://docs.microsoft.com/en-us/cli/azure/postgres/flexible-server?view=azure-cli-latest#az_postgres_flexible_server_create[create] command, see https://docs.microsoft.com/en-us/cli/azure/postgres/flexible-server?view=azure-cli-latest#az_postgres_flexible_server_create[az postgres flexible-server create] documentation.

Upon successful database creation, you will receive a JSON object that contains important information about your new database.

[source,json,title=JSON output]
----
{
  "connectionString": "postgresql://postgres:<your-password>@fusionauth-db-example.postgres.database.azure.com/postgres?sslmode=require",
  "databaseName": "flexibleserverdb",
  "firewallName": "AllowAllAzureServicesAndResourcesWithinAzureIps_2021-10-10_23-34-29",
  "host": "fusionauth-db-example.postgres.database.azure.com",
  "id": "/subscriptions/2683a458-c361-4b5e-87d9-a4e5237d5b91/resourceGroups/fusionauthResourceGroup/providers/Microsoft.DBforPostgreSQL/flexibleServers/fusionauth-db-example",
  "location": "West US",
  "password": "your-password",
  "resourceGroup": "fusionauthResourceGroup",
  "skuname": "Standard_D2s_v3",
  "username": "postgres",
  "version": "12"
}
----

Take note of the database username, password and hostname, as those will be needed to configure FusionAuth. If you need to retrieve this information later, you can use the following command to get a list of flexible servers:

[source,shell,title=List available flexible servers]
----
$ az postgres flexible-server list
----

== Install the Elastic Stack (ELK)

Recall the resource group created in the first steps of this guide link:<<Create a resource group>>
The first step will be to create a resource group if you have not already done so.

[source,shell,title=Create a resource group]
----
$ az group create --name fusionauthRG --location eastus
----

Next you will need to create a virtual machine to run Elasticsearch on. You will want to supply your public SSH key so that you can access the VM once it has been provisioned.

[source,shell,title=Create an Azure VM]
----
$ az vm create \
  --resource-group fusionauthRG \
  --name esVM \
  --image UbuntuLTS \
  --admin-username fusionauth-admin \
  --ssh-key-values ~/.ssh/fusionauth.pub
----

[source,shell,title=Output]
----
{
  "fqdns": "",
  "id": "/subscriptions/2683a458-c361-4b5e-87d9-a4e5237d5b91/resourceGroups/fusionauthRG/providers/Microsoft.Compute/virtualMachines/esVM",
  "location": "eastus",
  "macAddress": "00-0D-3A-56-04-E9",
  "powerState": "VM running",
  "privateIpAddress": "10.0.0.4",
  "publicIpAddress": "20.106.243.22",
  "resourceGroup": "fusionauthRG",
  "zones": ""
}
----

SSH to the VM:

[source,shell,title=SSH to the VM]
----
$ ssh fusionauth-admin@20.106.243.22
----

[source,shell,title=Add Elasticsearch signing key]
----
$ wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -
----

[source,shell,title=Update APT sources for Elasticsearch 7 package repository]
----
$ echo "deb https://artifacts.elastic.co/packages/7.x/apt stable main" | sudo tee /etc/apt/sources.list.d/elastic-7.x.list
----

Using Java 11 as it is the most widely compatible version with Elasticsearch versions.

[source,shell,title=Install Java]
----
$ sudo apt update && sudo apt install openjdk-11-jre-headless
----

[source,shell,title=Set JAVA_HOME]
----
$ export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
----

[source,shell,title=Start Elasticsearch]
----
$ sudo systemctl start elasticsearch.service
----

[source,shell,title=Verify Elasticsearch is running]
----
$ sudo curl -XGET 'localhost:9200/
----

[source,json,title=Output]
----
{
  "name" : "esVM",
  "cluster_name" : "elasticsearch",
  "cluster_uuid" : "JSZ-tynwTL6-lmAUIYjXmg",
  "version" : {
    "number" : "7.15.1",
    "build_flavor" : "default",
    "build_type" : "deb",
    "build_hash" : "83c34f456ae29d60e94d886e455e6a3409bba9ed",
    "build_date" : "2021-10-07T21:56:19.031608185Z",
    "build_snapshot" : false,
    "lucene_version" : "8.9.0",
    "minimum_wire_compatibility_version" : "6.8.0",
    "minimum_index_compatibility_version" : "6.0.0-beta1"
  },
  "tagline" : "You Know, for Search"
}
----


== Next Steps

You now are running all the necessary infrastructure to deploy a containerized application to AKS.

Next up, link:../../[Deploy FusionAuth in Kubernetes].

